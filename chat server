#include <WiFi.h>
#include <AsyncTCP.h>
#include <ESPAsyncWebServer.h>

const char* ssid = "ESP32_CHAT";
const char* password = "StrongPass123";

AsyncWebServer server(80);
AsyncWebSocket ws("/ws");

#define MAX_CLIENTS 10
String usernames[MAX_CLIENTS];

/* ---------- HTML ---------- */
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background:#f0f0f0; text-align:center; }
#chat { width:90%; max-width:500px; height:300px; margin:auto;
        background:white; overflow:auto; border:1px solid #ccc; padding:10px;}
input, button { padding:8px; margin:5px; }
#users { margin:10px; font-weight:bold; }
</style>
</head>
<body>

<h2>ESP32 Live Chat</h2>
<div id="users">Online users: 0</div>

<div id="login">
  <input id="username" placeholder="Enter username">
  <button onclick="joinChat()">Join</button>
</div>

<div id="chatUI" style="display:none;">
  <div id="chat"></div>
  <input id="msg" placeholder="Type message">
  <button onclick="sendMsg()">Send</button>
</div>

<script>
let ws;
let username = "";

function joinChat() {
  username = document.getElementById("username").value;
  if (!username) return;

  document.getElementById("login").style.display = "none";
  document.getElementById("chatUI").style.display = "block";

  ws = new WebSocket("ws://" + location.host + "/ws");

  ws.onopen = function() {
    ws.send("__join__:" + username);
  };

  ws.onmessage = function(event) {
    let data = event.data;

    if (data.startsWith("__count__:")) {
      let count = data.split(":")[1];
      document.getElementById("users").innerText = "Online users: " + count;
      return;
    }

    let chat = document.getElementById("chat");

    let now = new Date();
    let time = now.getHours().toString().padStart(2, '0') + ":" +
               now.getMinutes().toString().padStart(2, '0');

    chat.innerHTML += "<div>[" + time + "] " + data + "</div>";
    chat.scrollTop = chat.scrollHeight;
  };
}

function sendMsg() {
  let input = document.getElementById("msg");
  if (!input.value) return;

  ws.send(username + ": " + input.value);
  input.value = "";
}
</script>

</body>
</html>
)rawliteral";

/* ---------- Helper ---------- */
int getUserCount() {
  int count = 0;
  for (int i = 0; i < MAX_CLIENTS; i++) {
    if (usernames[i] != "") count++;
  }
  return count;
}

void broadcastUserCount() {
  int count = getUserCount();
  ws.textAll("__count__:" + String(count));
}

/* ---------- WebSocket ---------- */
void onWsEvent(AsyncWebSocket *server,
               AsyncWebSocketClient *client,
               AwsEventType type,
               void *arg,
               uint8_t *data,
               size_t len) {

  if (type == WS_EVT_DATA) {
    String msg = "";
    for (size_t i = 0; i < len; i++) {
      msg += (char)data[i];
    }

    // Join message
    if (msg.startsWith("__join__:")) {
      String name = msg.substring(9);

      usernames[client->id() % MAX_CLIENTS] = name;
      ws.textAll(name + " joined the chat");
      broadcastUserCount();
      return;
    }

    // Normal chat message
    ws.textAll(msg);
  }

  if (type == WS_EVT_DISCONNECT) {
    int idx = client->id() % MAX_CLIENTS;
    String name = usernames[idx];

    if (name != "") {
      ws.textAll(name + " left the chat");
      usernames[idx] = "";
      broadcastUserCount();
    }
  }
}

/* ---------- Setup ---------- */
void setup() {
  Serial.begin(115200);

  WiFi.softAP(ssid, password);
  Serial.print("AP IP: ");
  Serial.println(WiFi.softAPIP());

  ws.onEvent(onWsEvent);
  server.addHandler(&ws);

  server.on("/", HTTP_GET, [](AsyncWebServerRequest *request){
    request->send_P(200, "text/html", index_html);
  });

  server.begin();
}

void loop() {
}

